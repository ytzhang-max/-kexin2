<script>
    // 全局变量
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let errorBook = {};
    let tags = new Set();
    let activeTag = null;

    // DOM元素
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    const loadBtn = document.getElementById('load-btn');
    const questionContainer = document.getElementById('question-container');
    const questionSubject = document.getElementById('question-subject');
    const questionLevel = document.getElementById('question-level');
    const questionTag = document.getElementById('question-tag');
    const questionNumber = document.getElementById('question-number');
    const questionTitle = document.getElementById('question-title');
    const optionsContainer = document.getElementById('options');
    const checkBtn = document.getElementById('check-btn');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const addToErrorBtn = document.getElementById('add-to-error-btn');
    const explanation = document.getElementById('explanation');
    const explanationContent = document.getElementById('explanation-content');
    const questionList = document.getElementById('question-list');
    const progressInfo = document.getElementById('progress-info');
    const currentQuestionSpan = document.getElementById('current-question');
    const totalQuestionsSpan = document.getElementById('total-questions');
    const progressBar = document.getElementById('progress-bar');
    const searchInput = document.getElementById('search-input');
    const errorSearchInput = document.getElementById('error-search-input');
    const filterTags = document.getElementById('filter-tags');
    const errorBookList = document.getElementById('error-book-list');
    const mainTabs = document.getElementById('main-tabs');
    const tabContents = document.querySelectorAll('.tab-content');
    const notification = document.getElementById('notification');

    // 统计元素
    const totalCountEl = document.getElementById('total-count');
    const answeredCountEl = document.getElementById('answered-count');
    const correctRateEl = document.getElementById('correct-rate');
    const errorCountEl = document.getElementById('error-count');
    const subjectStatsEl = document.getElementById('subject-stats');

    // 初始化
    function init() {
        // 从本地存储加载数据
        loadUserDataFromLocalStorage();
        document.getElementById('reset-stats-btn').addEventListener('click', resetStatistics);
        // 事件监听器
        fileInput.addEventListener('change', handleFileSelect);
        loadBtn.addEventListener('click', loadQuestions);
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', nextQuestion);
        prevBtn.addEventListener('click', prevQuestion);
        addToErrorBtn.addEventListener('click', addToErrorBook);
        searchInput.addEventListener('input', filterQuestions);
        errorSearchInput.addEventListener('input', filterErrorBook);

        // 标签页切换事件
        mainTabs.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                mainTabs.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}-content`).classList.add('active');

                // 如果切换到错题本，重新渲染错题列表
                if (tabId === 'error-book') {
                    renderErrorBook();
                } else if (tabId === 'statistics') {
                    updateStatistics();
                }
            });
        });
    }

    // 文件选择处理
    function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
            fileName.textContent = file.name;
        } else {
            fileName.textContent = '未选择文件';
        }
    }

    // 添加重置统计函数
    function resetStatistics() {
        if (confirm('确定要重置所有数据吗？这将清除所有答题记录和错题本。')) {
            userAnswers = {};
            errorBook = {};
            localStorage.removeItem('userAnswers');
            localStorage.removeItem('errorBook');
            updateStatistics();
            renderErrorBook();
            showNotification('数据已重置', 'success');
        }
    }

    // 从本地存储加载用户数据
    function loadUserDataFromLocalStorage() {
        const storedAnswers = localStorage.getItem('userAnswers');
        const storedErrorBook = localStorage.getItem('errorBook');

        if (storedAnswers) {
            userAnswers = JSON.parse(storedAnswers);
        }

        if (storedErrorBook) {
            errorBook = JSON.parse(storedErrorBook);
        }
    }

    // 保存用户数据到本地存储
    function saveUserDataToLocalStorage() {
        localStorage.setItem('userAnswers', JSON.stringify(userAnswers));
        localStorage.setItem('errorBook', JSON.stringify(errorBook));
    }

    // 读取并解析TXT文件
    function loadQuestions() {
        const file = fileInput.files[0];
        if (!file) {
            showNotification('请先选择题目文件', 'error');
            return;
        }

        showNotification('正在加载题目...', 'success');

        const reader = new FileReader();
        reader.onload = function (e) {
            const content = e.target.result;
            parseQuestions(content);
            if (questions.length > 0) {
                // 提取所有标签
                questions.forEach(q => {
                    if (q.tag) tags.add(q.tag);
                });

                // 渲染标签过滤器
                renderFilterTags();

                showQuestionList();
                showCurrentQuestion();
                progressInfo.classList.remove('hidden');
                updateStatistics();
                showNotification(`已成功加载 ${questions.length} 道题目`, 'success');
            } else {
                showNotification('未找到有效题目，请检查文件格式', 'error');
            }
        };
        reader.readAsText(file, 'UTF-8');
    }

    // 解析题目
    function parseQuestions(content) {
        questions = [];
        let lines = content.split('\n');
        let currentQuestion = null;
        let inExplanation = false;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            if (line === '') {
                continue;
            }

            if (line === '------------') {
                if (currentQuestion && Object.keys(currentQuestion).length > 0) {
                    questions.push(currentQuestion);
                    currentQuestion = null;
                    inExplanation = false;
                }
                continue;
            }

            if (inExplanation && currentQuestion) {
                currentQuestion.explanation += '\n' + line;
                continue;
            }

            if (line.startsWith('【科目】')) {
                currentQuestion = {options: []};
                currentQuestion.subject = line.replace('【科目】', '').trim();
            } else if (currentQuestion && line.startsWith('【认证级别】')) {
                currentQuestion.level = line.replace('【认证级别】', '').trim();
            } else if (currentQuestion && line.startsWith('【标签】')) {
                currentQuestion.tag = line.replace('【标签】', '').trim();
            } else if (currentQuestion && line.startsWith('【题号】')) {
                currentQuestion.number = line.replace('【题号】', '').trim();
            } else if (currentQuestion && line.startsWith('【题目】')) {
                let title = line.replace('【题目】', '').trim();
                let j = i + 1;
                let inCodeBlock = false;
                console.log(title);
                while (j < lines.length) {
                    const nextLine = lines[j].trim();
                    // 检查是否进入或退出代码块
                    if (nextLine.startsWith('```')) {
                        inCodeBlock = !inCodeBlock;
                    }
                    // 如果遇到下一个标签或题目分隔符，停止读取
                    if (nextLine.match(/^[A-Z]\. /) || nextLine.startsWith('【') || nextLine === '------------') {
                        break;
                    }
                    title += '\n' + lines[j]; // 保留原始行内容
                    j++;
                }
                currentQuestion.title = title;
                console.log(currentQuestion);
            } else if (currentQuestion && line.startsWith('【答案】')) {
                currentQuestion.answer = line.replace('【答案】', '').trim();
            } else if (currentQuestion && line.startsWith('【题解】')) {
                currentQuestion.explanation = '';
                inExplanation = true;
            } else if (currentQuestion && line.match(/^[A-Z]\. /)) {
                const key = line[0];
                let text = line.substring(3).trim(); // 提取选项键和初始文本
                let j = i + 1;
                // 继续读取后续行直到遇到下一个选项、答案、题解或题目结束
                while (j < lines.length) {
                    const nextLine = lines[j].trim();
                    // 检查是否是下一个选项、答案、题解或题目分隔符
                    if (nextLine.match(/^[A-Z]\. /) ||
                        nextLine.startsWith('【答案】') ||
                        nextLine.startsWith('【题解】') ||
                        nextLine === '------------') {
                        break;
                    }
                    // 添加到选项文本中，保留原始换行
                    text += '\n' + lines[j]; // 使用原始行（包含空格和空行）
                    j++;
                }
                // 更新i的值到已处理的位置
                i = j - 1;
                currentQuestion.options.push({key, text});
            }
        }

        // 添加最后一个题目
        if (currentQuestion && Object.keys(currentQuestion).length > 0) {
            questions.push(currentQuestion);
        }

        totalQuestionsSpan.textContent = questions.length;
        updateProgressBar();
    }

    // 渲染标签过滤器
    function renderFilterTags() {
        filterTags.innerHTML = '<div class="filter-tag active" data-tag="all">全部</div>';

        tags.forEach(tag => {
            const tagEl = document.createElement('div');
            tagEl.className = 'filter-tag';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            filterTags.appendChild(tagEl);
        });

        // 标签点击事件
        filterTags.querySelectorAll('.filter-tag').forEach(tagEl => {
            tagEl.addEventListener('click', () => {
                filterTags.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                tagEl.classList.add('active');

                activeTag = tagEl.dataset.tag === 'all' ? null : tagEl.dataset.tag;
                filterQuestions();
            });
        });
    }

    // 显示当前题目
    function showCurrentQuestion() {
        if (questions.length === 0) {
            return;
        }

        const question = questions[currentQuestionIndex];
        questionContainer.classList.remove('hidden');
        questionSubject.textContent = `科目: ${question.subject || ''}`;
        questionLevel.textContent = `级别: ${question.level || ''}`;
        questionTag.textContent = question.tag || '';
        questionNumber.textContent = `题号: ${question.number || ''}`;

        // 显示题目标题
        questionTitle.innerHTML = ''; // 清空原有内容
        console.log(question.title);

        // 检查题目是否包含代码块
        if (question.title.includes("```")) {
            // 按代码块分隔符拆分
            console.log(question.title);
            const segments = question.title.split(/```/g);

            segments.forEach((segment, index) => {
                if (index % 2 === 0) {
                    // 普通文本
                    const textNode = document.createTextNode(segment);
                    questionTitle.appendChild(textNode);
                } else {
                    // 代码块
                    const pre = document.createElement('pre');
                    pre.className = 'code-block';
                    pre.textContent = segment;
                    questionTitle.appendChild(pre);
                }
            });
        } else {
            // 无代码块，直接设置文本
            questionTitle.textContent = question.title || '';
        }


        // 判断是单选还是多选
        const isMultiChoice = question.title.includes('多选');

        // 显示选项
        optionsContainer.innerHTML = '';

        question.options.forEach(option => {
            const optionElement = document.createElement('div');
            optionElement.className = 'option';

            const optionKey = document.createElement('div');
            optionKey.className = 'option-key';
            optionKey.textContent = option.key;

            const optionText = document.createElement('div');
            optionText.className = 'option-text';

            const pre = document.createElement('pre');
            pre.textContent = option.text; // 确保 option.text 包含 \n
            optionText.appendChild(pre);
            console.log('option.text:', option.text);

            optionElement.appendChild(optionKey);
            optionElement.appendChild(optionText);

            optionElement.dataset.key = option.key;

            // 恢复用户之前的选择
            if (userAnswers[question.number]) {
                if (isMultiChoice) {
                    if (Array.isArray(userAnswers[question.number]) &&
                        userAnswers[question.number].includes(option.key)) {
                        optionElement.classList.add('selected');
                    }
                } else {
                    if (userAnswers[question.number] === option.key) {
                        optionElement.classList.add('selected');
                    }
                }
            }

            optionElement.addEventListener('click', () => {
                if (isMultiChoice) {
                    optionElement.classList.toggle('selected');
                    const selected = Array.from(
                        optionsContainer.querySelectorAll('.option.selected')
                    ).map(el => el.dataset.key);
                    userAnswers[question.number] = selected;
                } else {
                    optionsContainer.querySelectorAll('.option').forEach(
                        el => el.classList.remove('selected')
                    );
                    optionElement.classList.add('selected');
                    userAnswers[question.number] = option.key;
                }
                updateQuestionList();
                saveUserDataToLocalStorage();
                updateStatistics();
            });

            optionsContainer.appendChild(optionElement);
        });

        // 重置答案解释
        explanation.style.display = 'none';

        // 隐藏加入错题本按钮
        addToErrorBtn.classList.add('hidden');

        // 更新题目导航
        updateQuestionList();
        currentQuestionSpan.textContent = currentQuestionIndex + 1;
        updateProgressBar();
    }

    // 更新进度条
    function updateProgressBar() {
        if (questions.length === 0) return;

        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
    }
